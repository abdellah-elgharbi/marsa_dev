pipeline {
	agent any
    tools {
		maven 'Maven3'
    }
    environment{
		REMOTE_HOST="kali@192.168.25.139"
	}
    stages {

		stage("Build") {
			steps {
				sh '''
				cd back/discovery-Client
				mvn clean package -DskipTests'''
            }
        }

        stage('Docker Up Discovery Service') {
			steps {
				sh '''
                    cd back/discovery-Client
                    docker build -t discovery-service:1.2 .
                    docker run -d -p 8761:8761 --name discovery-service discovery-service:1.2
                '''
            }
        }

        stage("push to distance server"){
			steps{
				sh '''
			    docker save discovery-service:1.2 | ssh $REMOTE_HOST "docker load"

			'''
			}

		}
		  stage("deploy"){
			steps{
				sh '''
			    ssh $REMOTE_HOST
			    docker stop discovery-service || true
			    docker rm discovery-service || true
			    docker run -d --name discovery-service -p 8761:8761 discovery-service:1.2
			'''

		}
		}
    }

    post {
		always {
			sh '''
                docker stop discovery-service || true
                docker rm discovery-service || true
            '''
            echo "Pipeline termin√©e"
        }
    }
}
